# 就算是萝莉控也能看懂的iptables防火墙命令
## 语法
### 基本语法
```shell
iptables (选项) (参数)
```
### 规则管理
```shell
iptables [-t 表名] <-A/D/I/R> 规则链 [规则号] [-i/o 网卡名] [-p 协议名] [ -s 源IP/源子网 --sport 源端口 -d 目标IP/目标子网 --dport 目标端口 ] -j 动作
```

以上即为 `iptables` 的规则管理命令格式，`[]`内容为非必选，`<>`中内容为任选其一

- `t` 为选择表名，放空默认为`filter`，详见 [表名](#表名)
- `A/D/I/R` 为规则操作，**必选其中一项**，详见 [常用选项](#常用选项)，其后跟 [规则链](#规则链)
- `-i/-o` 为指定网卡，放空默认为所有网卡执行该规则
- `p` 协议名，放空默认为所有协议执行该规则
- `-s 源IP/源子网` 源地址，放空默认为所有来源数据包执行该规则
- `-sport 源端口` 源端口，放空默认为任何来源端口数据包执行该规则
- `-d 目标IP/目标子网` 目的地址，放空默认为任何目的的数据包执行该规则
- `--dport 目标端口` 目的端口，放空默认为任何目的端口数据包执行该规则
- `j` 指定动作，**必选**，详见 [动作](#动作)

## 常用选项

|选项|作用|
|:---:|:---:|
|`-P`|	设置默认策略：`iptables -P 规则链 动作` 
|`-F`|	清空规则链：`iptables -F [规则链]` 未指定规则链则清空所有
|`-L`|	查看规则链：`iptables -L [规则链]` 未选则显示所有内容
|`-A`|	在规则链的末尾加入新规则：`iptables -A 规则链 ...规则...`
|`-D`|	删除某一条规则：`iptables -D 规则链 规则号`(使用规则号删除规则) or  `iptables -D 规则链 ...规则...`(使用规则删除时必须要与插入规则时的规则完全相同)
|`-I`|	在规则链的指定位置插入新规则：`iptables -I 规则链 [规则号] ...规则...` 规则号在其中非必选，未选则插入到规则链头
|`-R`|	在规则链中替换规则：`iptables -I 规则链 规则号 ...规则...` 规则号在其中必选
|`-s`|	匹配来源地址IP/MASK，加叹号"!"表示除这个IP外：`-s IP`
|`-d`|	匹配目标地址：`-d IP`
|`-i`|	匹配从这块网卡流入的数据：`-i 网卡`
|`-o`|	匹配从这块网卡流出的数据：`-o 网卡`
|`-p`|	匹配协议，如tcp、udp、icmp：`-p 协议`
|`--dport num`| 	匹配目标端口号：`--dport 端口`
|`--sport num`| 	匹配来源端口号：`--sport 端口`
|`-j`|	指定规则的目标动作，详见 [动作](#动作)
|`--line-numbers`|显示行数，常与`L`一同使用
|`-v`|显示详细的信息，包括流量统计，常与`L`一同使用
|`-n`|以数字形式显示IP地址和端口号，不进行DNS解析，常与`L`一同使用

## 选项细节说明
### 表名

| 表名        | 作用                                      |
|:---:|:---:|
| `filter`    | 默认表，用于处理过滤规则，如`INPUT`、`FORWARD`、`OUTPUT` |
| `nat`       | 网络地址转换表，用于处理源地址转换（SNAT）和目的地址转换（DNAT） |
| `mangle`    | 数据包修改表，用于更改数据包头部的信息，如TOS、TTL等 |
| `raw`       | 原始数据包表，用于处理数据包的排除和跟踪规则       |

其中在防火墙配置中 **filter** 最为常用

### 规则链

| 规则链    | 作用                                      |
|:---:|:---:|
| `INPUT`   | 处理入站数据包，决定是否允许数据包进入本机   |
| `FORWARD` | 处理转发的数据包，决定是否允许数据包通过本机转发 |
| `OUTPUT`  | 处理出站数据包，决定是否允许数据包离开本机   |
| `PREROUTING` | 在路由决策前处理数据包，常用于DNAT         |
| `POSTROUTING` | 在路由决策后处理数据包，常用于SNAT         |

在所有情况中 **INPUT** 规则链都最为常用

在服务器的使用中 **FORWARD OUTPUT** 也较为常用

### 动作

| 动作        | 作用                                      |
|:---:|:---:|
| `ACCEPT`    | 允许数据包通过，接收并继续处理             |
| `DROP`      | 丢弃数据包，直接丢弃不做任何处理           |
| `REJECT`    | 拒绝数据包，通常会向源主机返回一个ICMP错误消息 |
| `SNAT`      | 源地址转换，将数据包的源地址修改为指定地址   |
| `DNAT`      | 目的地址转换，将数据包的目的地址修改为指定地址 |
| `LOG`       | 记录数据包信息到系统日志中，通常用于调试   |
| `RETURN`    | 终止当前链的处理，返回到调用链继续处理     |

其中 **ACCEPT DROP REJECT** 可作为规则链的默认动作，同时这三个动作在防火墙管理中也最为常用

## 配置导出及导入
### 导出命令
语法
```shell
iptables-save > path/to/file
```

示例
```shell
iptables-save > ~/iptables.bak #将 iptables 当前配置保存到 ~/iptables.bak 文件
```

### 导入命令
语法
```shell
iptables-restore < path/to/file
```
示例
```shell
iptables-restore < ~/iptables.bak #将 ~/iptables.bak 文件配置导入到 iptables
```


<script src="/js/menu.js"></script>